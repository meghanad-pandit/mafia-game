<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>God Panel - Mafia Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: auto;
      padding: 15px 10px 40px 10px;
      background: #f7f9fc;
      color: #222;
    }
    h2 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: bold;
      color: #2c3e50;
    }

    #godLoginBox {
      margin-bottom: 15px;
      text-align: center;
    }

    #godKeyInput {
      width: 60%;
      padding: 8px 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-right: 5px;
      box-sizing: border-box;
    }

    #godLoginBtn {
      padding: 9px 15px;
      font-size: 1rem;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #godLoginBtn:hover {
      background-color: #2980b9;
    }

    #loginError {
      color: red;
      margin-top: 8px;
      min-height: 20px;
    }

    #adminControls {
      display: none;
      margin-top: 15px;
    }

    button.actionBtn {
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      margin: 5px 5px 10px 0;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button.actionBtn:hover:not(:disabled) {
      background-color: #1e8449;
    }
    button.actionBtn:disabled {
      background-color: #7f8c8d;
      cursor: not-allowed;
    }

    /* Table container for horizontal scroll */
    .tableWrapper {
      overflow-x: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 380px;
    }

    thead {
      background-color: #3498db;
      color: white;
      font-weight: bold;
      font-size: 0.9rem;
    }

    tbody tr {
      border-bottom: 1px solid #ddd;
      height: 36px;
    }

    tbody tr:hover {
      background-color: #f1faff;
    }

    td, th {
      padding: 6px 10px;
      text-align: center;
      font-size: 0.85rem;
      vertical-align: middle;
      white-space: nowrap;
    }

    td.keyCell {
      color: #2980b9;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: color 0.3s ease;
    }
    td.keyCell.copied {
      color: #27ae60;
    }

    select.roleSelect {
      padding: 3px 6px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    button.deleteBtn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #c0392b;
      font-size: 1.2rem;
      transition: color 0.3s ease;
    }
    button.deleteBtn:hover {
      color: #e74c3c;
    }

  </style>
</head>
<body>

  <h2>üëë God Panel</h2>

  <div id="godLoginBox">
    <input id="godKeyInput" placeholder="Enter God Key" autocomplete="off" />
    <button id="godLoginBtn">Login</button>
    <p id="loginError"></p>
  </div>

  <div id="adminControls">
    <button id="addPlayerBtn" class="actionBtn">Add Player</button>
    <button id="startGameBtn" class="actionBtn">‚ñ∂ Start Game</button>
    <button id="resetGameBtn" class="actionBtn">‚ùå Reset Players</button>

    <div class="tableWrapper" style="margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Key (Click to Copy)</th>
            <th>Role</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="playersTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const godKeyInput = document.getElementById('godKeyInput');
    const godLoginBtn = document.getElementById('godLoginBtn');
    const loginError = document.getElementById('loginError');
    const adminControls = document.getElementById('adminControls');
    const playersTableBody = document.getElementById('playersTableBody');

    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const startGameBtn = document.getElementById('startGameBtn');
    const resetGameBtn = document.getElementById('resetGameBtn');

    let players = [];
    let gameStarted = false;

    // Login handler
    godLoginBtn.onclick = async () => {
      const key = godKeyInput.value.trim();
      loginError.textContent = "";
      if (!key) {
        loginError.textContent = "Please enter the God key";
        return;
      }
      try {
        const res = await fetch('/god/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        if (!res.ok) {
          loginError.textContent = "‚ùå Invalid God Key";
          return;
        }
        adminControls.style.display = 'block';
        godLoginBtn.disabled = true;
        godKeyInput.disabled = true;
        loadPlayers();
      } catch {
        loginError.textContent = "Error connecting to server";
      }
    };

    // Load players and refresh table
    async function loadPlayers() {
      try {
        const res = await fetch('/players');
        const data = await res.json();
        players = data.players || [];
        gameStarted = data.gameStarted || false;

        // Disable start button if game started
        startGameBtn.disabled = gameStarted;

        playersTableBody.innerHTML = '';

        players.forEach(p => {
          const tr = document.createElement('tr');

          // Name cell
          const nameTd = document.createElement('td');
          nameTd.textContent = p.name;
          tr.appendChild(nameTd);

          // Key cell - clickable copy
          const keyTd = document.createElement('td');
          keyTd.textContent = p.key;
          keyTd.classList.add('keyCell');
          keyTd.title = 'Click to copy key';
          keyTd.onclick = () => {
            navigator.clipboard.writeText(p.key).then(() => {
              keyTd.classList.add('copied');
              setTimeout(() => keyTd.classList.remove('copied'), 1500);
            });
          };
          tr.appendChild(keyTd);

          // Role cell - select box editable if game not started
          const roleTd = document.createElement('td');
          if (gameStarted) {
            roleTd.textContent = p.role;
          } else {
            const select = document.createElement('select');
            select.className = 'roleSelect';
            ['Villager', 'Mafia', 'Detective', 'Doctor'].forEach(roleOption => {
              const option = document.createElement('option');
              option.value = roleOption;
              option.textContent = roleOption;
              if (p.role === roleOption) option.selected = true;
              select.appendChild(option);
            });
            select.onchange = async () => {
              await fetch('/assignRole', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: p.key, role: select.value })
              });
              loadPlayers();
            };
            roleTd.appendChild(select);
          }
          tr.appendChild(roleTd);

          // Delete cell - trash icon button
          const delTd = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.className = 'deleteBtn';
          delBtn.title = 'Delete Player';
          delBtn.innerHTML = '&#128465;'; // Trash can unicode icon
          delBtn.onclick = async () => {
            if (!confirm(`Delete player "${p.name}"?`)) return;
            await fetch('/deletePlayer', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ key: p.key })
            });
            loadPlayers();
          };
          delTd.appendChild(delBtn);
          tr.appendChild(delTd);

          playersTableBody.appendChild(tr);
        });
      } catch {
        // silently fail or you can show a message
      }
    }

    // Add player prompt and API call
    addPlayerBtn.onclick = async () => {
      const name = prompt("Enter player name:");
      if (!name || !name.trim()) return;
      try {
        await fetch('/addPlayer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name.trim() })
        });
        loadPlayers();
      } catch {
        alert("Failed to add player");
      }
    };

    // Start game
    startGameBtn.onclick = async () => {
      try {
        await fetch('/startGame', { method: 'POST' });
        gameStarted = true;
        startGameBtn.disabled = true;
        loadPlayers();
      } catch {
        alert("Failed to start game");
      }
    };

    // Reset players and game
    resetGameBtn.onclick = async () => {
      if (!confirm("Are you sure you want to reset the game and delete all players?")) return;
      try {
        await fetch('/resetGame', { method: 'POST' });
        gameStarted = false;
        startGameBtn.disabled = false;
        loadPlayers();
      } catch {
        alert("Failed to reset game");
      }
    };
  </script>
</body>
</html>
